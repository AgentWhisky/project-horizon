<div class="flex flex-col gap-3">
  <hz-breadcrumb [items]="breadcrumbItems"></hz-breadcrumb>

  <mat-tab-group [selectedIndex]="currentTabIndex()" (selectedTabChange)="onTabChange($event)" dynamicHeight>
    <!-- DASHBOARD -->
    <mat-tab label="Dashboard">
      @let dashboard = steamInsightDashboard();
      <div class="flex flex-col gap-3 py-3">
        <!-- LOAD SUCCESS -->
        @if(dashboard && dashboardLoadingState.isSuccess()) {
        <!-- App Stats -->
        <hz-stat-card-group showPrimaryHeader>
          @for(stat of steamInsightDashboard()?.appStats; track stat.displayName) {
          <hz-stat-card>
            <hz-stat-card-title>{{ stat.displayName }}</hz-stat-card-title>
            <hz-stat-card-value>{{ stat.value }}</hz-stat-card-value>
          </hz-stat-card>
          }
        </hz-stat-card-group>

        <!-- STEAM INSIGHT UPDATE DISPLAY -->
        <div class="grid gap-3" [class.grid-cols-1]="isMobileScreen()" [class.grid-cols-2]="!isMobileScreen()">
          <!-- IN PROGRESS STEAM INSIGHT UPDATE-->
          @if(runningUpdate()) {
          <hz-card primary>
            <hz-card-header>In-Progress Update</hz-card-header>
            <hz-card-chip>
              <hz-chip>Running</hz-chip>
            </hz-card-chip>
            <hz-card-body>
              <div class="flex flex-col gap-3">
                <div class="flex flex-col gap-3">
                  <div>
                    <span class="font-semibold">Start Time</span>
                    <div>{{ runningUpdate()!.startTime | date : 'M/d/yyyy, h:mm a' }}</div>
                  </div>
                </div>
                <div>
                  <span class="font-semibold">Events</span>
                  <ul class="list-disc list-inside">
                    @for (event of runningUpdate()!.events; track event.message) {
                    <li>{{ event.timestamp | date : 'M/d/yyyy, h:mm a' }} - {{ event.message | formatDate }}</li>
                    }
                  </ul>
                </div>

                <button matButton="filled" (click)="onStopUpdate()">Stop Update</button>
              </div>
            </hz-card-body>
          </hz-card>
          } @else {
          <!-- NO RUNNING STEAM INSIGHT UPDATE-->
          <hz-card primary>
            <hz-card-header>No update in progress</hz-card-header>
            <hz-card-body class="flex flex-row flex-wrap gap-3">
              <button matButton="filled" class="flex flex-grow" (click)="onStartUpdate()">
                <mat-icon>sync_alt</mat-icon>
                Start Incremental Update
              </button>
              <button matButton="filled" class="flex flex-grow" (click)="onStartUpdate(true)">
                <mat-icon>sync</mat-icon>
                Start Full Update
              </button>
            </hz-card-body>
          </hz-card>
          }

          <div class="grid gap-3">
            @for (update of steamInsightDashboard()?.recentUpdates; track update.id) {
            <hz-card primary>
              <hz-card-header>{{ update.updateType | updateType }} Update</hz-card-header>
              <hz-card-chip>
                <hz-chip [type]="update.updateStatus | updateStatusType">{{ update.updateStatus | updateStatus }}</hz-chip>
              </hz-card-chip>

              <hz-card-body>
                <div class="grid grid-cols-2 gap-3 w-full">
                  <div>
                    <span class="font-semibold">Start Time</span>
                    <div>{{ update.startTime | date : 'M/d/yyyy, h:mm a' }}</div>
                  </div>
                  <div>
                    <span class="font-semibold">End Time</span>
                    <div>{{ update.endTime ? (update.endTime | date : 'M/d/yyyy, h:mm a') : '—' }}</div>
                  </div>
                </div>
              </hz-card-body>
            </hz-card>

            }
          </div>
        </div>
        }
        <!-- LOAD IN-PROGRESS -->
        @else if (dashboardLoadingState.isLoading()) {
        <hz-loading-spinner text="Loading Steam Insight Dashboard..."></hz-loading-spinner>
        }

        <!-- LOAD FAILURE -->
        @else if(dashboardLoadingState.isFailed()) {
        <hz-banner type="error">
          <hz-banner-header>{{ dashboardLoadingState.errorMessage()?.header }}</hz-banner-header>
          <hz-banner-body>{{ dashboardLoadingState.errorMessage()?.body }}</hz-banner-body>
        </hz-banner>
        }
      </div>
    </mat-tab>

    <!-- APP SEARCH -->
    <mat-tab label="Steam App Search">
      @let apps = steamInsightApps();
      <div class="flex flex-row flex-wrap gap-3 py-3 justify-center">
        <!-- LOAD SUCCESS -->
        @if(appsLoadingState.isSuccess()) {
        <hz-card primary>
          <hz-card-header>
            <mat-icon>filter_alt</mat-icon>
            Filter
          </hz-card-header>
          <hz-card-body>
            <form [formGroup]="appsSearchForm" class="flex flex-col gap-3">
              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Appid</mat-label>
                <input matInput formControlName="appid" type="number" inputmode="numeric" pattern="[0-9]*" />
              </mat-form-field>

              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Keywords</mat-label>
                <input matInput formControlName="keywords" />
              </mat-form-field>

              <mat-form-field subscriptSizing="dynamic">
                <mat-label>App Type</mat-label>
                <mat-select formControlName="type">
                  <mat-option [value]="null">None</mat-option>
                  @for (type of appsTypeOptions(); track type.value) {
                  <mat-option [value]="type.value">{{ type.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Is Adult</mat-label>
                <mat-select formControlName="isAdult">
                  <mat-option [value]="null">None</mat-option>
                  <mat-option [value]="true">Yes</mat-option>
                  <mat-option [value]="false">No</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Validation Failed</mat-label>
                <mat-select formControlName="validationFailed">
                  <mat-option [value]="null">None</mat-option>
                  <mat-option [value]="true">Yes</mat-option>
                  <mat-option [value]="false">No</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Active</mat-label>
                <mat-select formControlName="active">
                  <mat-option [value]="null">None</mat-option>
                  <mat-option [value]="true">Yes</mat-option>
                  <mat-option [value]="false">No</mat-option>
                </mat-select>
              </mat-form-field>

              <button matButton="filled" (click)="onResetAppSearchFilters()">
                <mat-icon>refresh</mat-icon>
                Reset
              </button>
            </form>
          </hz-card-body>
        </hz-card>

        <hz-card class="flex flex-grow">
          <hz-card-body>
            <div class="w-full flex flex-col">
              <table
                mat-table
                [dataSource]="appsDataSource"
                matSort
                (matSortChange)="onAppSort($event)"
                #steamInsightAppsSort="matSort"
                class="mat-elevation-z8">
                <ng-container matColumnDef="appid">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by app id">Appid</th>
                  <td mat-cell *matCellDef="let element">{{ element.appid }}</td>
                </ng-container>

                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name">Name</th>
                  <td mat-cell *matCellDef="let element">{{ element.name }}</td>
                </ng-container>

                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by type">Type</th>
                  <td mat-cell *matCellDef="let element">
                    <hz-chip>{{ element.type | uppercase }}</hz-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="isAdult">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by is adult">Is Adult</th>
                  <td mat-cell *matCellDef="let element">
                    <hz-chip [type]="element.isAdult ? 'error' : 'success'">{{ element.isAdult ? 'Yes' : 'No' }}</hz-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="validationFailed">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by is validation status">
                    Validation Failed
                  </th>
                  <td mat-cell *matCellDef="let element">
                    <hz-chip [type]="element.validationFailed ? 'error' : 'success'">{{ element.validationFailed ? 'Yes' : 'No' }}</hz-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="active">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by active status">Active</th>
                  <td mat-cell *matCellDef="let element">
                    <hz-chip [type]="element.active ? 'success' : 'error'">{{ element.active ? 'Yes' : 'No' }}</hz-chip>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="appsDisplayedColumns()"></tr>
                <tr mat-row class="table-row-clickable" (click)="onViewApp(row)" *matRowDef="let row; columns: appsDisplayedColumns()"></tr>
              </table>
              @if (apps && apps.length > 0) {
              <mat-paginator
                [length]="appsPageLength()"
                [pageIndex]="appsPage()"
                [pageSize]="appsPageSize()"
                [pageSizeOptions]="PAGE_SIZE_OPTIONS"
                (page)="onAppPageChange($event)"
                showFirstLastButtons
                aria-label="Steam Insight App Search Paginator"
                #steamInsightAppsPaginator></mat-paginator>
              } @else {
              <hz-banner type="warning" class="mt-3">
                <hz-banner-header>No apps found</hz-banner-header>
                <hz-banner-body>
                  There are no records that match the current filters in the Steam Insight Apps. Try adjusting your search criteria or
                  refresh the table to check for newly available apps.
                </hz-banner-body>
              </hz-banner>
              }
            </div>
          </hz-card-body>
        </hz-card>
        }

        <!-- LOAD IN-PROGRESS -->
        @else if (appsLoadingState.isLoading()) {
        <hz-loading-spinner text="Loading Steam Insight Apps..."></hz-loading-spinner>
        }

        <!-- LOAD FAILURE -->
        @else if(appsLoadingState.isFailed()) {
        <hz-banner type="error">
          <hz-banner-header>{{ appsLoadingState.errorMessage()?.header }}</hz-banner-header>
          <hz-banner-body>{{ appsLoadingState.errorMessage()?.body }}</hz-banner-body>
        </hz-banner>
        }
      </div>
    </mat-tab>

    <!-- UPDATE SEARCH -->
    <mat-tab label="Steam Update History">
      @let updates = steamInsightUpdates();
      <div class="flex flex-row flex-wrap gap-3 py-3 justify-center">
        <!-- LOAD SUCCESS -->
        @if(updatesLoadingState.isSuccess()) {
        <hz-card>
          <hz-card-header>
            <mat-icon>filter_alt</mat-icon>
            Filter
          </hz-card-header>
          <hz-card-body>
            <form [formGroup]="updatesSearchForm" class="flex flex-col gap-3">
              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Update Status</mat-label>
                <mat-select formControlName="statuses" multiple>
                  @for (status of updatesStatusOptions(); track status.value) {
                  <mat-option [value]="status.value">{{ status.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field subscriptSizing="dynamic">
                <mat-label>Update Type</mat-label>
                <mat-select formControlName="type">
                  <mat-option [value]="null">None</mat-option>
                  @for (type of updatesTypeOptions(); track type.value) {
                  <mat-option [value]="type.value">{{ type.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <button matButton="filled" (click)="onResetUpdateSearchFilters()">
                <mat-icon>refresh</mat-icon>
                Reset
              </button>
            </form>
          </hz-card-body>
        </hz-card>

        <hz-card class="flex flex-grow">
          <hz-card-body>
            <div class="w-full flex flex-col">
              <table
                mat-table
                [dataSource]="updatesDataSource"
                matSort
                (matSortChange)="onUpdateSort($event)"
                #steamInsightUpdateSort="matSort"
                class="mat-elevation-z8">
                <ng-container matColumnDef="startTime">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by start time">Start Time</th>
                  <td mat-cell *matCellDef="let element">{{ element.startTime | date : 'M/d/yyyy, h:mm a' }}</td>
                </ng-container>

                <ng-container matColumnDef="endTime">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by end time">End Time</th>
                  <td mat-cell *matCellDef="let element">{{ element.endTime ? (element.endTime | date : 'M/d/yyyy, h:mm a') : '—' }}</td>
                </ng-container>

                <ng-container matColumnDef="totalRuntime">
                  <th mat-header-cell *matHeaderCellDef>Total Runtime</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.endTime ? (element.startTime | duration : element.endTime) : '—' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="updateStatus">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by update status">Update Status</th>
                  <td mat-cell *matCellDef="let element">
                    <hz-chip [type]="element.updateStatus | updateStatusType">{{ element.updateStatus | updateStatus }}</hz-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="updateType">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by update type">Update Type</th>
                  <td mat-cell *matCellDef="let element">
                    <hz-chip>{{ element.updateType | updateType }}</hz-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="notes">
                  <th mat-header-cell *matHeaderCellDef>Notes</th>
                  <td mat-cell *matCellDef="let element">{{ element.notes }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="steamInsightUpdatesDisplayedColumns()"></tr>
                <tr
                  mat-row
                  class="table-row-clickable"
                  *matRowDef="let row; columns: steamInsightUpdatesDisplayedColumns()"
                  (click)="onViewUpdate(row)"></tr>
              </table>
              @if (updates && updates.length > 0) {
              <mat-paginator
                [length]="updatesPageLength()"
                [pageIndex]="updatesPage()"
                [pageSize]="updatesPageSize()"
                [pageSizeOptions]="PAGE_SIZE_OPTIONS"
                (page)="onUpdatePageChange($event)"
                showFirstLastButtons
                aria-label="Steam Insight Updates Paginator"
                #steamInsightUpdatesPaginator></mat-paginator>
              } @else {
              <hz-banner type="warning" class="mt-3">
                <hz-banner-header>No update history found</hz-banner-header>
                <hz-banner-body>
                  There are no records that match the current filters in the Steam Insight Update History. Try adjusting your search
                  criteria or refresh the table to check for newly available updates.
                </hz-banner-body>
              </hz-banner>
              }
            </div>
          </hz-card-body>
        </hz-card>
        }

        <!-- LOAD IN-PROGRESS -->
        @else if (updatesLoadingState.isLoading()) {
        <hz-loading-spinner text="Loading Steam Insight Updates..."></hz-loading-spinner>
        }

        <!-- LOAD FAILURE -->
        @else if(updatesLoadingState.isFailed()) {
        <hz-banner type="error">
          <hz-banner-header>{{ updatesLoadingState.errorMessage()?.header }}</hz-banner-header>
          <hz-banner-body>{{ updatesLoadingState.errorMessage()?.body }}</hz-banner-body>
        </hz-banner>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
